function Note(){var t=this,e=document.createElement("div");e.className="note",e.addEventListener("mousedown",function(e){return t.onMouseDown(e)},!1),e.addEventListener("click",function(){return t.onNoteClick()},!1),this.note=e;var n=document.createElement("div");n.className="closebutton",n.addEventListener("click",function(e){return t.close(e)},!1),e.appendChild(n);var i=document.createElement("div");i.className="edit",i.setAttribute("contenteditable",!0),i.addEventListener("keyup",function(){return t.onKeyUp()},!1),e.appendChild(i),this.editField=i;var o=document.createElement("div");return o.className="timestamp",o.addEventListener("mousedown",function(e){return t.onMouseDown(e)},!1),e.appendChild(o),this.lastModified=o,document.body.appendChild(e),this}function loaded(){db.transaction(function(t){t.executeSql("SELECT COUNT(*) FROM MyStickys",[],function(t){loadNotes()},function(t,e){t.executeSql("CREATE TABLE MyStickys (id REAL UNIQUE, note TEXT, timestamp REAL, left TEXT, top TEXT, zindex REAL)",[],function(t){loadNotes()})})})}function loadNotes(){db.transaction(function(t){t.executeSql("SELECT id, note, timestamp, left, top, zindex FROM MyStickys",[],function(t,e){for(var n=0;n<e.rows.length;++n){var i=e.rows.item(n),o=new Note;o.id=i.id,o.text=i.note,o.timestamp=i.timestamp,o.left=i.left,o.top=i.top,o.zIndex=i.zindex,i.id>highestId&&(highestId=i.id),i.zindex>highestZ&&(highestZ=i.zindex)}e.rows.length||newNote()},function(t,e){alert("Failed to retrieve notes from database - "+e.message)})})}function modifiedString(t){return"Note Last Modified: "+t.getFullYear()+"-"+(t.getMonth()+1)+"-"+t.getDate()+" "+t.getHours()+":"+t.getMinutes()+":"+t.getSeconds()}function newNote(){var t=new Note;t.id=++highestId,t.timestamp=(new Date).getTime(),t.left=Math.round(400*Math.random())+"px",t.top=Math.round(500*Math.random())+"px",t.zIndex=++highestZ,t.saveAsNew()}var db=null;window.openDatabase?(db=openDatabase("NoteTest","1.0","Stickys Database",1e7),db||alert("Failed to open database")):alert("Failed to open database, make sure your browser supports HTML5 web storage");var captured=null,highestZ=0,highestId=0;Note.prototype={get id(){return"_id"in this||(this._id=0),this._id},set id(t){this._id=t},get text(){return this.editField.innerHTML},set text(t){this.editField.innerHTML=t},get timestamp(){return"_timestamp"in this||(this._timestamp=0),this._timestamp},set timestamp(t){if(this._timestamp!=t){this._timestamp=t;var e=new Date;e.setTime(parseFloat(t)),this.lastModified.textContent=modifiedString(e)}},get left(){return this.note.style.left},set left(t){this.note.style.left=t},get top(){return this.note.style.top},set top(t){this.note.style.top=t},get zIndex(){return this.note.style.zIndex},set zIndex(t){this.note.style.zIndex=t},close:function(t){this.cancelPendingSave();var e=this;db.transaction(function(t){t.executeSql("DELETE FROM MyStickys WHERE id = ?",[e.id])}),document.body.removeChild(this.note)},saveSoon:function(){this.cancelPendingSave();var t=this;this._saveTimer=setTimeout(function(){t.save()},200)},cancelPendingSave:function(){"_saveTimer"in this&&(clearTimeout(this._saveTimer),delete this._saveTimer)},save:function(){this.cancelPendingSave(),"dirty"in this&&(this.timestamp=(new Date).getTime(),delete this.dirty);var t=this;db.transaction(function(e){e.executeSql("UPDATE MyStickys SET note = ?, timestamp = ?, left = ?, top = ?, zindex = ? WHERE id = ?",[t.text,t.timestamp,t.left,t.top,t.zIndex,t.id])})},saveAsNew:function(){this.timestamp=(new Date).getTime();var t=this;db.transaction(function(e){e.executeSql("INSERT INTO MyStickys (id, note, timestamp, left, top, zindex) VALUES (?, ?, ?, ?, ?, ?)",[t.id,t.text,t.timestamp,t.left,t.top,t.zIndex])})},onMouseDown:function(t){captured=this,this.startX=t.clientX-this.note.offsetLeft,this.startY=t.clientY-this.note.offsetTop,this.zIndex=++highestZ;var e=this;return"mouseMoveHandler"in this||(this.mouseMoveHandler=function(t){return e.onMouseMove(t)},this.mouseUpHandler=function(t){return e.onMouseUp(t)}),document.addEventListener("mousemove",this.mouseMoveHandler,!0),document.addEventListener("mouseup",this.mouseUpHandler,!0),!1},onMouseMove:function(t){return this!=captured?!0:(this.left=t.clientX-this.startX+"px",this.top=t.clientY-this.startY+"px",!1)},onMouseUp:function(t){return document.removeEventListener("mousemove",this.mouseMoveHandler,!0),document.removeEventListener("mouseup",this.mouseUpHandler,!0),this.save(),!1},onNoteClick:function(t){this.editField.focus(),getSelection().collapseToEnd()},onKeyUp:function(){this.dirty=!0,this.saveSoon()}},null!=db&&addEventListener("load",loaded,!1);